<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Solitaire Max - –£–ª—É—á—à–µ–Ω–Ω—ã–π –ü–∞—Å—å—è–Ω—Å</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap');

  /* Reset */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    background: linear-gradient(135deg, #0a192f, #1e3a8a);
    font-family: 'Rubik', sans-serif;
    color: #f0f0f0;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }

  h1 {
    margin: 1rem 0 0.5rem 0;
    font-weight: 700;
    font-size: 2.5rem;
    text-shadow: 0 0 10px #22c55e;
  }

  #gameInfo {
    display: flex;
    gap: 2rem;
    margin-bottom: 1rem;
    font-size: 1.2rem;
    font-weight: 500;
    user-select: none;
  }

  #controls {
    margin: 1rem 0;
    display: flex;
    gap: 1rem;
  }

  button {
    background: linear-gradient(135deg, #10b981, #059669);
    border: none;
    border-radius: 0.7rem;
    padding: 0.6rem 1.2rem;
    font-weight: 700;
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 0 12px #10b981;
    transition: transform 0.2s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  button:hover {
    box-shadow: 0 0 20px #22c55e;
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.95);
    box-shadow: 0 0 8px #059669;
  }
  button:disabled {
    background: #555;
    cursor: default;
    box-shadow: none;
  }

  #gameBoard {
    position: relative;
    width: 960px;
    max-width: 95vw;
    height: 600px;
    background: #111827;
    border-radius: 1rem;
    box-shadow: 0 0 25px #22c55e;
    padding: 1rem;
    display: flex;
    gap: 0.5rem;
    overflow: visible;
    user-select: none;
  }

  /* –°—Ç–æ–ª–±—ã –∫–æ–ª–æ–¥ –∏ —Å—Ç–æ–ø–∫–∏ */
  .pile {
    flex: 1;
    position: relative;
    background: #1f2937;
    border-radius: 0.7rem;
    box-shadow: inset 0 0 15px #0f172a;
    padding: 0.5rem;
    min-width: 110px;
    min-height: 420px;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow: visible;
  }
  .pile-label {
    text-align: center;
    font-size: 0.9rem;
    color: #a5b4fc;
    margin-bottom: 0.3rem;
    user-select: none;
  }

  /* –ö–∞—Ä—Ç–∞ */
  .card {
    width: 100px;
    height: 140px;
    border-radius: 0.7rem;
    background: white;
    box-shadow: 0 6px 12px rgba(0,0,0,0.5);
    position: absolute;
    cursor: grab;
    user-select: none;
    transition: box-shadow 0.3s ease, transform 0.3s ease;
    touch-action: none;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 0.5rem 0.6rem;
    font-weight: 700;
    font-size: 1.4rem;
    color: #111827;
    user-select: none;
  }
  .card.red {
    color: #e02424;
  }
  .card.face-down {
    background: linear-gradient(135deg, #2563eb, #1e40af);
    box-shadow: 0 6px 15px #1e3a8a;
    cursor: pointer;
  }
  .card.face-down::before {
    content: "üÇ†";
    font-size: 3.5rem;
    line-height: 140px;
    text-align: center;
    display: block;
    user-select: none;
    pointer-events: none;
  }
  .card.dragging {
    cursor: grabbing;
    box-shadow: 0 0 40px #22c55e;
    transform: scale(1.1);
    z-index: 1000 !important;
  }
  .card.highlight {
    box-shadow: 0 0 15px 5px #10b981;
    transform: scale(1.05);
    z-index: 500;
  }

  /* –ö–∞—Ä—Ç–æ—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã */
  .card .top-left, .card .bottom-right {
    font-size: 1.4rem;
    user-select: none;
  }
  .card .bottom-right {
    transform: rotate(180deg);
    align-self: flex-end;
  }

  /* –°—Ç–æ–ø–∫–∏ –¥–ª—è —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞ */
  #foundations {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  #foundations .pile {
    min-height: 140px;
    min-width: 100px;
    padding: 0.3rem;
  }

  /* –°—Ç–æ–ø–∫–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ª–æ–¥—ã –∏ —Å–±—Ä–æ—Å–∞ */
  #stockWaste {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    align-items: center;
  }
  #stockWaste .pile {
    width: 100px;
    height: 140px;
    padding: 0.3rem;
  }

  /* –¢–∞–π–º–µ—Ä –∏ —Å—á–µ—Ç—á–∏–∫ —Ö–æ–¥–æ–≤ */
  #stats {
    margin-top: 1rem;
    font-size: 1.15rem;
    font-weight: 600;
    color: #a5b4fc;
  }

  /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
  #hintBox {
    position: fixed;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: #22c55e;
    color: #111827;
    padding: 0.8rem 1.5rem;
    border-radius: 0.7rem;
    font-weight: 700;
    font-size: 1.1rem;
    box-shadow: 0 0 15px #16a34a;
    user-select: none;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 2000;
  }
  #hintBox.active {
    opacity: 1;
    pointer-events: all;
  }

  /* –ú–æ–±–∏–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è */
  @media (max-width: 720px) {
    #gameBoard {
      flex-wrap: wrap;
      height: auto;
      padding: 0.5rem;
    }
    .pile {
      min-width: 48vw;
      min-height: 280px;
      margin-bottom: 0.8rem;
    }
    #foundations .pile {
      min-width: 45vw;
      min-height: 140px;
    }
    #stockWaste {
      justify-content: center;
      margin-bottom: 0.5rem;
    }
  }
</style>
</head>
<body>
  <h1>‚ô†Ô∏è‚ô•Ô∏è Solitaire Max ‚ô£Ô∏è‚ô¶Ô∏è</h1>

  <div id="gameInfo" aria-live="polite" aria-atomic="true" role="region">
    <div id="moves">–•–æ–¥—ã: 0</div>
    <div id="timer">–í—Ä–µ–º—è: 00:00</div>
  </div>

  <div id="controls" role="group" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π">
    <button id="newGameBtn" aria-label="–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    <button id="undoBtn" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å —Ö–æ–¥" disabled>–û—Ç–º–µ–Ω–∞</button>
    <button id="hintBtn" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É">–ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
    <button id="soundToggleBtn" aria-label="–í–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫">–ó–≤—É–∫: –í–∫–ª</button>
  </div>

  <div id="stockWaste" aria-label="–ö–æ–ª–æ–¥–∞ –∏ —Å–±—Ä–æ—Å">
    <div id="stockPile" class="pile" aria-label="–ó–∞–ø–∞—Å–Ω–∞—è –∫–æ–ª–æ–¥–∞" tabindex="0"></div>
    <div id="wastePile" class="pile" aria-label="–°–±—Ä–æ—Å" tabindex="0"></div>
  </div>

  <div id="gameBoard" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –ø–∞—Å—å—è–Ω—Å–∞">
    <div id="tableau" class="pile" aria-label="–°—Ç–æ–ª–±—Ü—ã –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–∫–∏" tabindex="0"></div>
    <div id="foundations" aria-label="–§—É–Ω–¥–∞–º–µ–Ω—Ç">
      <div class="pile" id="foundation1" aria-label="–§—É–Ω–¥–∞–º–µ–Ω—Ç –ø–∏–∫–∏" tabindex="0"></div>
      <div class="pile" id="foundation2" aria-label="–§—É–Ω–¥–∞–º–µ–Ω—Ç —á–µ—Ä–≤—ã" tabindex="0"></div>
      <div class="pile" id="foundation3" aria-label="–§—É–Ω–¥–∞–º–µ–Ω—Ç —Ç—Ä–µ—Ñ—ã" tabindex="0"></div>
      <div class="pile" id="foundation4" aria-label="–§—É–Ω–¥–∞–º–µ–Ω—Ç –±—É–±–Ω—ã" tabindex="0"></div>
    </div>
  </div>

  <div id="hintBox" role="alert" aria-live="assertive"></div>

<script>
(() => {
  // –ö–∞—Ä—Ç—ã: –º–∞—Å—Ç—å, –∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Ü–≤–µ—Ç
  const suits = ['‚ô†', '‚ô•', '‚ô£', '‚ô¶'];
  const colors = { '‚ô†': 'black', '‚ô£': 'black', '‚ô•': 'red', '‚ô¶': 'red' };
  const ranks = [ 'A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K' ];

  // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  const newGameBtn = document.getElementById('newGameBtn');
  const undoBtn = document.getElementById('undoBtn');
  const hintBtn = document.getElementById('hintBtn');
  const soundToggleBtn = document.getElementById('soundToggleBtn');
  const stockPile = document.getElementById('stockPile');
  const wastePile = document.getElementById('wastePile');
  const tableau = document.getElementById('tableau');
  const foundations = [
    document.getElementById('foundation1'),
    document.getElementById('foundation2'),
    document.getElementById('foundation3'),
    document.getElementById('foundation4'),
  ];
  const movesCounter = document.getElementById('moves');
  const timerElem = document.getElementById('timer');
  const hintBox = document.getElementById('hintBox');

  // –ó–≤—É–∫
  let soundEnabled = true;
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  // –°—Ç–µ–π—Ç –∏–≥—Ä—ã
  let deck = [];
  let stock = [];
  let waste = [];
  let tableaus = [[], [], [], [], [], [], []]; // 7 —Å—Ç–æ–ª–±—Ü–æ–≤
  let foundationsCards = [[], [], [], []];
  let moves = 0;
  let timerInterval = null;
  let secondsElapsed = 0;
  let undoStack = [];
  let dragState = null; // –î–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
  let hintTimeout = null;

  // –ê—É–¥–∏–æ —Ñ—É–Ω–∫—Ü–∏–∏
  function playClick() {
    if (!soundEnabled) return;
    // –ö–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫ —â–µ–ª—á–∫–∞
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.type = 'square';
    osc.frequency.value = 800;
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.05);
  }

  // –°–æ–∑–¥–∞–µ–º –∫–æ–ª–æ–¥—É (52 –∫–∞—Ä—Ç—ã)
  function createDeck() {
    const cards = [];
    for (const suit of suits) {
      for (const rank of ranks) {
        cards.push({
          suit,
          rank,
          color: colors[suit],
          faceUp: false,
          id: `${rank}${suit}`,
        });
      }
    }
    return cards;
  }

  // –ü–µ—Ä–µ–º–µ—à–∞—Ç—å –º–∞—Å—Å–∏–≤
  function shuffle(array) {
    for (let i = array.length -1; i > 0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç—ã (—Å–æ–∑–¥–∞–µ—Ç DOM —ç–ª–µ–º–µ–Ω—Ç)
  function createCardElement(card) {
    const el = document.createElement('div');
    el.classList.add('card');
    if (card.color === 'red') el.classList.add('red');
    if (!card.faceUp) el.classList.add('face-down');
    el.setAttribute('data-id', card.id);
    el.setAttribute('tabindex', '0');
    el.setAttribute('aria-label', `${card.faceUp ? card.rank + ' ' + card.suit : '–õ–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –≤–Ω–∏–∑'}`);
    // –¢–µ–∫—Å—Ç –∏ –∑–Ω–∞—á–æ–∫
    if (card.faceUp) {
      el.innerHTML = `
        <div class="top-left">${card.rank}<br>${card.suit}</div>
        <div class="bottom-right">${card.rank}<br>${card.suit}</div>
      `;
    }
    return el;
  }

  // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç–æ–ª–±—Ü–æ–≤, –∫–æ–ª–æ–¥—ã –∏ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞
  function renderGame() {
    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö
    stockPile.innerHTML = '';
    wastePile.innerHTML = '';
    tableau.innerHTML = '';
    foundations.forEach(f => f.innerHTML = '');

    // –°—Ç–æ–∫ (–∫–æ–ª–æ–¥–∞)
    if (stock.length) {
      const card = stock[stock.length-1];
      const cardEl = createCardElement({ ...card, faceUp: false });
      cardEl.style.position = 'relative';
      stockPile.appendChild(cardEl);
    } else {
      stockPile.innerHTML = '<div style="color:#555;user-select:none;text-align:center;margin-top:60px;">–ü—É—Å—Ç–æ</div>';
    }

    // –°–±—Ä–æ—Å
    if (waste.length) {
      const card = waste[waste.length - 1];
      const cardEl = createCardElement(card);
      cardEl.style.position = 'relative';
      wastePile.appendChild(cardEl);
    } else {
      wastePile.innerHTML = '<div style="color:#555;user-select:none;text-align:center;margin-top:60px;">–ü—É—Å—Ç–æ</div>';
    }

    // –¢–∞–±–ª–æ ‚Äî 7 —Å—Ç–æ–ª–±—Ü–æ–≤
    for (let i = 0; i < 7; i++) {
      const column = document.createElement('div');
      column.classList.add('pile');
      column.style.position = 'relative';
      column.style.height = '420px';
      column.style.width = '110px';
      column.style.margin = '0 4px';
      column.style.flex = 'none';
      column.setAttribute('aria-label', `–°—Ç–æ–ª–±–µ—Ü ${i+1}`);
      column.setAttribute('data-column', i);

      // –ö–∞–∂–¥–∞—è –∫–∞—Ä—Ç–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ
      for (let j = 0; j < tableaus[i].length; j++) {
        const card = tableaus[i][j];
        const cardEl = createCardElement(card);
        cardEl.style.position = 'absolute';
        cardEl.style.top = (j * 25) + 'px';
        cardEl.style.left = '0';
        cardEl.style.zIndex = j + 1;
        if (!card.faceUp) {
          cardEl.classList.add('face-down');
        }
        // –î–æ–±–∞–≤–∏–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–∏—Ü–µ–≤—ã—Ö –∫–∞—Ä—Ç
        if (card.faceUp) {
          setupDragEvents(cardEl, i, j);
        }
        column.appendChild(cardEl);
      }

      tableau.appendChild(column);
    }

    // –§—É–Ω–¥–∞–º–µ–Ω—Ç—ã
    for (let f = 0; f < 4; f++) {
      if (foundationsCards[f].length) {
        const card = foundationsCards[f][foundationsCards[f].length - 1];
        const cardEl = createCardElement(card);
        cardEl.style.position = 'relative';
        foundations[f].appendChild(cardEl);
      } else {
        foundations[f].innerHTML = '<div style="color:#555;user-select:none;text-align:center;margin-top:60px;">–ü—É—Å—Ç–æ</div>';
      }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ —Ö–æ–¥–æ–≤
    movesCounter.textContent = `–•–æ–¥—ã: ${moves}`;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã
  function checkWin() {
    return foundationsCards.every(f => f.length === 13);
  }

  // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
  function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    secondsElapsed = 0;
    timerInterval = setInterval(() => {
      secondsElapsed++;
      timerElem.textContent = '–í—Ä–µ–º—è: ' + formatTime(secondsElapsed);
    }, 1000);
  }
  function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
  }
  function formatTime(sec) {
    const m = Math.floor(sec / 60).toString().padStart(2,'0');
    const s = (sec % 60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }

  // –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É
  function newGame() {
    stopTimer();
    moves = 0;
    undoStack = [];
    deck = createDeck();
    shuffle(deck);
    stock = deck.slice();
    waste = [];
    foundationsCards = [[], [], [], []];
    tableaus = [[], [], [], [], [], [], []];

    // –†–∞–∑–¥–∞—Ç—å –∫–∞—Ä—Ç—ã –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –ø–∞—Å—å—è–Ω—Å–∞
    for (let col = 0; col < 7; col++) {
      for (let row = 0; row <= col; row++) {
        let card = stock.shift();
        card.faceUp = (row === col);
        tableaus[col].push(card);
      }
    }

    renderGame();
    startTimer();
    undoBtn.disabled = true;
    hintBox.classList.remove('active');
  }

  // –£–º–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ ‚Äî –ø–æ–∫–∞–∂–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–π —Ö–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  function showHint() {
    clearTimeout(hintTimeout);
    // –ù–∞–π–¥–µ–º –ø–µ—Ä–≤—É—é –≤–æ–∑–º–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    for (let fromCol = 0; fromCol < 7; fromCol++) {
      const column = tableaus[fromCol];
      for (let cardIndex = 0; cardIndex < column.length; cardIndex++) {
        const card = column[cardIndex];
        if (!card.faceUp) continue;
        // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π —Å—Ç–æ–ª–±–µ—Ü
        for (let toCol = 0; toCol < 7; toCol++) {
          if (toCol === fromCol) continue;
          if (canMoveTableauToTableau(card, tableaus[toCol][tableaus[toCol].length -1] || null)) {
            highlightCard(fromCol, cardIndex);
            hintBox.textContent = `–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ ${card.rank}${card.suit} —Å —Å—Ç–æ–ª–±—Ü–∞ ${fromCol+1} –Ω–∞ —Å—Ç–æ–ª–±–µ—Ü ${toCol+1}`;
            hintBox.classList.add('active');
            hintTimeout = setTimeout(() => hintBox.classList.remove('active'), 5000);
            return;
          }
        }
        // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
        for (let f = 0; f < 4; f++) {
          if (canMoveTableauToFoundation(card, f)) {
            highlightCard(fromCol, cardIndex);
            hintBox.textContent = `–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ ${card.rank}${card.suit} –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç ${suits[f]}`;
            hintBox.classList.add('active');
            hintTimeout = setTimeout(() => hintBox.classList.remove('active'), 5000);
            return;
          }
        }
      }
    }
    // –ü–æ–¥—Å–∫–∞–∑–∫–∏ —Å–æ —Å–±—Ä–æ—Å–∞
    if (waste.length) {
      const card = waste[waste.length -1];
      for (let f = 0; f < 4; f++) {
        if (canMoveWasteToFoundation(card, f)) {
          highlightWaste();
          hintBox.textContent = `–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ ${card.rank}${card.suit} —Å–æ —Å–±—Ä–æ—Å–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç ${suits[f]}`;
          hintBox.classList.add('active');
          hintTimeout = setTimeout(() => hintBox.classList.remove('active'), 5000);
          return;
        }
      }
      for (let toCol = 0; toCol < 7; toCol++) {
        if (canMoveWasteToTableau(card, toCol)) {
          highlightWaste();
          hintBox.textContent = `–ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ ${card.rank}${card.suit} —Å–æ —Å–±—Ä–æ—Å–∞ –Ω–∞ —Å—Ç–æ–ª–±–µ—Ü ${toCol+1}`;
          hintBox.classList.add('active');
          hintTimeout = setTimeout(() => hintBox.classList.remove('active'), 5000);
          return;
        }
      }
    }
    hintBox.textContent = "–ü–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–µ—Ç. –í–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –≤–∑—è—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É –∏–∑ –∫–æ–ª–æ–¥—ã.";
    hintBox.classList.add('active');
    hintTimeout = setTimeout(() => hintBox.classList.remove('active'), 5000);
  }

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–∞—Ä—Ç—ã –≤ —Å—Ç–æ–ª–±—Ü–µ
  function highlightCard(col, idx) {
    clearHighlights();
    const column = tableau.querySelector(`[data-column="${col}"]`);
    if (!column) return;
    const cards = Array.from(column.querySelectorAll('.card'));
    if (cards[idx]) cards[idx].classList.add('highlight');
  }
  function highlightWaste() {
    clearHighlights();
    const card = wastePile.querySelector('.card');
    if (card) card.classList.add('highlight');
  }
  function clearHighlights() {
    document.querySelectorAll('.card.highlight').forEach(c => c.classList.remove('highlight'));
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–ª–æ–∂–∏—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ –¥—Ä—É–≥–æ–π —Å—Ç–æ–ª–±–µ—Ü
  function canMoveTableauToTableau(card, destCard) {
    if (!card) return false;
    if (!destCard) {
      // –ü–æ–ª–æ–∂–∏—Ç—å –∫–æ—Ä–æ–ª—è –Ω–∞ –ø—É—Å—Ç–æ–π —Å—Ç–æ–ª–±–µ—Ü –º–æ–∂–Ω–æ
      return card.rank === 'K';
    }
    // –¶–≤–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã, –∏ —Ä–∞–Ω–≥ –Ω–∞ 1 –º–µ–Ω—å—à–µ
    if (colors[card.suit] === colors[destCard.suit]) return false;
    if (rankValue(card.rank) !== rankValue(destCard.rank) -1) return false;
    return true;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–∂–Ω–æ –ª–∏ –ø–æ–ª–æ–∂–∏—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
  function canMoveTableauToFoundation(card, foundationIndex) {
    if (!card) return false;
    const foundation = foundationsCards[foundationIndex];
    if (foundation.length === 0) {
      // –ù–∞ –ø—É—Å—Ç–æ–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –º–æ–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç—É–∑–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –º–∞—Å—Ç–∏
      return card.rank === 'A' && suits[foundationIndex] === card.suit;
    } else {
      const topCard = foundation[foundation.length-1];
      if (card.suit !== topCard.suit) return false;
      return rankValue(card.rank) === rankValue(topCard.rank) + 1;
    }
  }
  function canMoveWasteToFoundation(card, foundationIndex) {
    return canMoveTableauToFoundation(card, foundationIndex);
  }
  function canMoveWasteToTableau(card, toCol) {
    return canMoveTableauToTableau(card, tableaus[toCol][tableaus[toCol].length -1] || null);
  }

  // –ó–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–Ω–≥–∞ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
  function rankValue(rank) {
    if (rank === 'A') return 1;
    if (rank === 'J') return 11;
    if (rank === 'Q') return 12;
    if (rank === 'K') return 13;
    return parseInt(rank, 10);
  }

  // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É —Å –æ–¥–Ω–æ–π —Å—Ç–æ–ø–∫–∏ –Ω–∞ –¥—Ä—É–≥—É—é (—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—Ç–µ–π—Ç–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π)
  function moveCardFromTableauToTableau(fromCol, cardIdx, toCol) {
    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ—Ç cardIdx –¥–æ –∫–æ–Ω—Ü–∞ –∏–∑ fromCol –≤ toCol
    const movingCards = tableaus[fromCol].slice(cardIdx);
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
    if (movingCards.length === 0) return false;
    if (!canMoveTableauToTableau(movingCards[0], tableaus[toCol][tableaus[toCol].length -1] || null)) return false;

    saveUndo();

    tableaus[toCol] = tableaus[toCol].concat(movingCards);
    tableaus[fromCol].splice(cardIdx);

    // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å –∫–∞—Ä—Ç–∞ –∏ –æ–Ω–∞ –ª–∏—Ü–æ–º –≤–Ω–∏–∑ - –æ—Ç–∫—Ä—ã—Ç—å
    const fromLast = tableaus[fromCol][tableaus[fromCol].length-1];
    if (fromLast && !fromLast.faceUp) {
      fromLast.faceUp = true;
    }

    moves++;
    renderGame();
    playClick();
    checkAndAlertWin();
    undoBtn.disabled = false;
    return true;
  }

  // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É —Å–æ —Å–±—Ä–æ—Å–∞ –Ω–∞ —Å—Ç–æ–ª–±–µ—Ü
  function moveWasteToTableau(toCol) {
    if (waste.length === 0) return false;
    const card = waste[waste.length - 1];
    if (!canMoveWasteToTableau(card, toCol)) return false;

    saveUndo();

    tableaus[toCol].push(card);
    waste.pop();

    moves++;
    renderGame();
    playClick();
    checkAndAlertWin();
    undoBtn.disabled = false;
    return true;
  }
  // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É —Å–æ —Å–±—Ä–æ—Å–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
  function moveWasteToFoundation(foundationIndex) {
    if (waste.length === 0) return false;
    const card = waste[waste.length - 1];
    if (!canMoveWasteToFoundation(card, foundationIndex)) return false;

    saveUndo();

    foundationsCards[foundationIndex].push(card);
    waste.pop();

    moves++;
    renderGame();
    playClick();
    checkAndAlertWin();
    undoBtn.disabled = false;
    return true;
  }

  // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É —Å–æ —Å—Ç–æ–ª–±—Ü–∞ –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
  function moveTableauToFoundation(fromCol) {
    if (tableaus[fromCol].length === 0) return false;
    const card = tableaus[fromCol][tableaus[fromCol].length -1];
    if (!card.faceUp) return false;

    for (let f = 0; f < 4; f++) {
      if (canMoveTableauToFoundation(card, f)) {
        saveUndo();

        foundationsCards[f].push(card);
        tableaus[fromCol].pop();

        // –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–∞—Ä—Ç—É, –µ—Å–ª–∏ –µ—Å—Ç—å
        const lastCard = tableaus[fromCol][tableaus[fromCol].length -1];
        if (lastCard && !lastCard.faceUp) lastCard.faceUp = true;

        moves++;
        renderGame();
        playClick();
        checkAndAlertWin();
        undoBtn.disabled = false;
        return true;
      }
    }
    return false;
  }

  // –í–∑—è—Ç—å –∫–∞—Ä—Ç—É –∏–∑ –∫–æ–ª–æ–¥—ã –≤ —Å–±—Ä–æ—Å
  function drawFromStock() {
    if (stock.length === 0) {
      // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—Å–µ –∏–∑ —Å–±—Ä–æ—Å–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–æ–ª–æ–¥—É, –ª–∏—Ü–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π –≤–Ω–∏–∑
      if (waste.length === 0) return false;
      saveUndo();
      stock = waste.reverse().map(c => ({ ...c, faceUp: false }));
      waste = [];
      moves++;
      renderGame();
      playClick();
      undoBtn.disabled = false;
      return true;
    } else {
      saveUndo();
      let card = stock.pop();
      card.faceUp = true;
      waste.push(card);
      moves++;
      renderGame();
      playClick();
      undoBtn.disabled = false;
      return true;
    }
  }

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ö–æ–¥–∞
  function saveUndo() {
    const state = {
      stock: [...stock],
      waste: [...waste],
      tableaus: tableaus.map(col => [...col]),
      foundationsCards: foundationsCards.map(f => [...f]),
      moves,
    };
    undoStack.push(state);
    if (undoStack.length > 50) undoStack.shift(); // –û–≥—Ä–∞–Ω–∏—á–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —Å—Ç–µ–∫–µ
  }

  // –û—Ç–º–µ–Ω–∞ —Ö–æ–¥–∞
  function undo() {
    if (undoStack.length === 0) return;
    const state = undoStack.pop();
    stock = state.stock;
    waste = state.waste;
    tableaus = state.tableaus;
    foundationsCards = state.foundationsCards;
    moves = state.moves;
    renderGame();
    undoBtn.disabled = undoStack.length === 0;
    hintBox.classList.remove('active');
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ
  function checkAndAlertWin() {
    if (checkWin()) {
      stopTimer();
      alert(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –∑–∞ ${formatTime(secondsElapsed)} –∏ ${moves} —Ö–æ–¥–æ–≤!`);
    }
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
  function setupDragEvents(cardEl, col, idx) {
    cardEl.draggable = true;
    cardEl.addEventListener('dragstart', e => {
      dragState = { fromCol: col, cardIdx: idx };
      e.dataTransfer.setData('text/plain', ''); // –î–ª—è Firefox
      setTimeout(() => {
        cardEl.style.visibility = 'hidden';
      }, 0);
    });
    cardEl.addEventListener('dragend', e => {
      dragState = null;
      cardEl.style.visibility = 'visible';
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è drop –Ω–∞ —Å—Ç–æ–ª–±—Ü–∞—Ö tableau
  tableau.addEventListener('dragover', e => {
    e.preventDefault();
  });
  tableau.addEventListener('drop', e => {
    e.preventDefault();
    if (!dragState) return;
    // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ–ª–±–µ—Ü, –∫—É–¥–∞ –±—Ä–æ—Å–∏–ª–∏
    let target = e.target;
    while (target && !target.hasAttribute('data-column')) {
      target = target.parentElement;
    }
    if (!target) return;
    const toCol = parseInt(target.getAttribute('data-column'), 10);
    if (dragState) {
      const { fromCol, cardIdx } = dragState;
      if (fromCol !== toCol) {
        if (moveCardFromTableauToTableau(fromCol, cardIdx, toCol)) {
          dragState = null;
        }
      }
    }
  });

  // –ö–ª–∏–∫ –ø–æ –∑–∞–ø–∞—Å–Ω–æ–π –∫–æ–ª–æ–¥–µ (stockPile)
  stockPile.addEventListener('click', () => {
    if (drawFromStock()) playClick();
  });

  // –ö–ª–∏–∫ –ø–æ —Å–±—Ä–æ—Å—É (wastePile)
  wastePile.addEventListener('click', () => {
    if (waste.length === 0) return;
    const card = waste[waste.length -1];
    // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª–æ–∂–∏—Ç—å –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
    for (let f = 0; f < 4; f++) {
      if (moveWasteToFoundation(f)) {
        playClick();
        return;
      }
    }
    // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª–æ–∂–∏—Ç—å –Ω–∞ —Å—Ç–æ–ª–±–µ—Ü
    for (let toCol = 0; toCol < 7; toCol++) {
      if (moveWasteToTableau(toCol)) {
        playClick();
        return;
      }
    }
  });

  // –ö–ª–∏–∫ –ø–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç—É –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ä—Ç—ã —Å–æ —Å—Ç–æ–ª–±—Ü–∞
  foundations.forEach((foundationElem, idx) => {
    foundationElem.addEventListener('click', () => {
      for (let col = 0; col < 7; col++) {
        if (moveTableauToFoundation(col)) {
          playClick();
          break;
        }
      }
    });
  });

  // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  newGameBtn.addEventListener('click', () => newGame());
  undoBtn.addEventListener('click', () => undo());
  hintBtn.addEventListener('click', () => showHint());
  soundToggleBtn.addEventListener('click', () => {
    soundEnabled = !soundEnabled;
    soundToggleBtn.textContent = `–ó–≤—É–∫: ${soundEnabled ? '–í–∫–ª' : '–í—ã–∫–ª'}`;
  });

  // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  newGame();
})();
</script>
